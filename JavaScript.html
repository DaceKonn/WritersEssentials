<script>

window.addEventListener('load', function() {
    console.log('Page is loaded');
});

var dashData = {};

var statTemplate = `<div class="stat-card mdl-card mdl-shadow--2dp mdl-cell mdl-cell--2-col mdl-cell--2-col-tablet mdl-cell--2-col-desktop">
            <div class="mdl-card__title mdl-card--expand">
                <h2 class="mdl-card__title-text">{title}</h2>
            </div>
            <div class="mdl-card__supporting-text mdl-color-text--grey-600">
                <span id="{id}" class="stat-support-text">{value}</span>
            </div>
            </div>`;

var fileTrackTableTemplate = `<div class="table-responsive"><table class="mdl-data-table mdl-js-data-table">
                            <thead>
                            <tr>
                                <th class="mdl-data-table__cell--non-numeric">Name</th>
                                <th>Word Count</th>
                                <th>Char Count</th>
                                <th>Goal</th>
                                <th>Progress</th>
                                <th>Pages</th>
                            </tr>
                            </thead>
                            <tbody>
                            {rows}
                            
                            </tbody>
                            </table></div>
                            `;
var fileTrackRowTemplate = `<tr>
                            <td class="mdl-data-table__cell--non-numeric">{name}</td>
                            <td>{wordCount}</td>
                            <td>{charCount}</td>
                            <td>{goal}</td>
                            <td>{progress}</td>
                            <td>{pages}</td>
                            </tr>`;

var fileListTableTemplate = `<div class="table-responsive"><table class="mdl-data-table mdl-js-data-table">
                            <thead>
                            <tr>
                                <th class="mdl-data-table__cell--non-numeric">Name</th>
                            </tr>
                            </thead>
                            <tbody>
                            {rows}
                            
                            </tbody>
                            </table></div>
                            `;

var fileListRowTemplate = `<tr>
                            <td class="mdl-data-table__cell--non-numeric" onclick="trackFile('{id}')">{name}</td>
                            </tr>`;

function onSuccessGetDashboardData(result) {
    dashData = result;
    var statsDiv = document.getElementById('mainGrid');
    statsDiv.innerHTML = "";
    result.Stats.forEach(element => {
        addStatCard(statsDiv, element);
    });
    
    trackDiv = document.getElementById('fileTrackList');
    

    var trackRows = ""
    result.FileTrack.forEach(element => {
        var progress = 0;
        if (element.WordCount >= 0 && element.Goal > 0) {
            progress = Math.floor(element.WordCount/element.Goal*100)+"%";
        }
        var pages = Math.ceil(element.WordCount/300) + " - " + Math.ceil(element.WordCount/250) + " / " + Math.ceil(element.CharCount/1800);
        var row = fileTrackRowTemplate
        .replace("{name}", element.Name)
        .replace("{wordCount}", element.WordCount)
        .replace("{charCount}", element.CharCount)
        .replace("{goal}", element.Goal)
        .replace("{progress}", progress)
        .replace("{pages}", pages);
        trackRows += row;
    });

    trackDiv.innerHTML = fileTrackTableTemplate
                        .replace("{rows}", trackRows);
}

function onFailureGetDashboardData(error) {
    var div = document.getElementById('mainGrid');
    div.innerHTML = "ERROR retreving data!";
}

function replaceInnerHtml(id, newContet) {
    var div = document.getElementById(id);
    div.innerHTML = newContet;
}

function addStatCard(div, stat){

    var value;

    if (/\d{4}z\d{2}-\d{2}$/.test(stat.Value)) {
        value = stat.Value.replace("z", "-");
    }
    else {
        value = stat.Value;
    }

    div.innerHTML += statTemplate
        .replace("{id}", stat.Id)
        .replace("{title}", stat.DisplayName)
        .replace("{value}", value);
}

function onSuccessGetFiles(result) {
    var addDialogDiv = document.getElementById('addDialogContent');
    var rows = "";

    result.forEach(element => {
        rows += fileListRowTemplate
            .replace("{name}", element.Name)
            .replace("{id}", element.Id);
        
    });

    addDialogDiv.innerHTML= fileListTableTemplate.replace("{rows}", rows);
}
function onFailureGetFiles(error) {
    var addDialogDiv = document.getElementById('addDialogContent');
    addDialogDiv.innerHTML = "ERROR retriving file list";
}

var dialog = document.querySelector('dialog');
var showDialogButton = document.querySelector('#show-dialog');
if (! dialog.showModal) {
    dialogPolyfill.registerDialog(dialog);
}
showDialogButton.addEventListener('click', function() {
    google.script.run.withSuccessHandler(onSuccessGetFiles).withFailureHandler(onFailureGetFiles).GetFiles();
    dialog.showModal();
});
dialog.querySelector('.close').addEventListener('click', function() {
    dialog.close();
});

function trackFile(fileId) {
    google.script.run.AddFileToTrack(fileId);
    dialog.close();
    location.reload();
}





google.script.run.withSuccessHandler(onSuccessGetDashboardData).withFailureHandler(onFailureGetDashboardData).GetDashboardData();


</script>